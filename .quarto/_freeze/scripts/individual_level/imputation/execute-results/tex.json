{
  "hash": "1780a809f8e3e2980763c9230b48ba90",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Individual-level analysis: data imputation\"\nsubtitle: \"Part of the final project for AQMSS II\"\nformat:\n  pdf:\n    fig-pos: \"H\"\n    fontsize: 11pt\n    highlight-style: kate\n    fig-width: 10\n    fig-height: 6\n    include-in-header:\n      - text: |\n          \\addtokomafont{disposition}{\\rmfamily} \n          \\AddToHook{env/Highlighting/begin}{\\scriptsize} \n          \\usepackage{float} \n          \\usepackage[backend = biber, style = apa]{biblatex}\n          \\addbibresource{project.bib}\nembed-resources: true\nexecute: \n  echo: true\n  warning: false\n  error: false\n  message: false\n  cache: true\n---\n\n\n\\section{Imputation}\n\nIn this section we impute values for the dataset values on the individual level. The number of predictors for high-quality imputations is limited. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(here::here(\"utilities\", \"check_packages.R\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nep_raw_dep <- read_rds(here(\"data\", \"data_built\", \"ep_raw_dep.rds\"))\n```\n:::\n\n\nWe first select relevant variables. Note that we do not impute the \"vote\" variable. This is because it does not include missing values other than \"Declined to answer\". It might be an interesting exercise to impute vote choices and the literature indicates that imputing the outcome is not problematic in most scenarios \\parencite{woods_best_2024}. However the censoring of the outcome is interesting in and of itself, which is why we choose to model it explicitly. \\footnote{In particular, we are interested in a scenario where all \"Declined to answer\" come from the supporters of the incumbent.}\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nep_mice_prep <- ep_raw_dep |> \n  select(\n    # Identificators and fixed effects\n    countryname_en, countrycode_c, countrycode_n, city_en, voting_station, \n    # Variables to be imputed\n    vote, sex, age_bin, out_of_Russia_time, time_to_vs.less_than_hour, \n    time_to_vs.more_than_4hours, result_trust_bin,\n    # Auxiallary variables\n    time_to_vs, result_trust) |> \n  mutate(across(c(-vote), ~ as.factor(if_else(. %in% c(\"No Data\",\n                                                       \"Declined to answer\"), \n                                              NA, .))),\n         city_en = as.integer(city_en))\n```\n:::\n\n\n\nUpon examining the distributions of missingness, with x-axis indicating the variables and y-axis the missing dummies in them, it becomes apparent that the missingness is primarily dependent on the \"Declined to answer\" category of the vote question. This means that people that refused to disclose their choice of vote also didn't share their socio-demographic data. This means that we are unlikely to get unbiased  estimates for that category, or, indeed for its combination with the honest incumbent vote answers. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlabelled::var_label(ep_mice_prep) <- list(\n  vote = \"Vote\", sex = \"Sex\", age_bin = \"Age\", \n  time_to_vs.more_than_4hours = \"> 4 hours to vs\\nvoting station\",\n  time_to_vs.less_than_hour = \"< 1 hour to\\nvoting station\",\n  out_of_Russia_time = \"Out of Russia time\",\n  result_trust_bin = \"Trust - binary\",\n  countryname_en = \"Country\")\n\nep_mice_prep |> \n  missing_pairs(dependent = \"vote\", \n                explanatory = c(\"sex\", \"age_bin\", \n                                \"time_to_vs.more_than_4hours\",\n                                \"time_to_vs.less_than_hour\",\n                                \"out_of_Russia_time\",\n                                \"result_trust_bin\"),\n                position = \"fill\") +\n    theme(axis.text.x = element_text(angle = 90, hjust = 1),\n          strip.text.y = element_text(angle = 0))\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/missingness matrix-1.pdf)\n:::\n\n```{.r .cell-code}\nep_mice_prep |> \n  filter(vote != \"Declined to answer\") |> \n  missing_pairs(dependent = \"vote\", \n                explanatory = c(\"sex\", \"age_bin\", \n                                \"time_to_vs.more_than_4hours\",\n                                \"time_to_vs.less_than_hour\",\n                                \"out_of_Russia_time\",\n                                \"result_trust_bin\"),\n                position = \"fill\") +\n    theme(axis.text.x = element_text(angle = 90, hjust = 1),\n          strip.text.y = element_text(angle = 0))\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/missingness matrix-2.pdf)\n:::\n:::\n\n\nThere remain (very) significant differences between countries in terms of vote non-disclosure rates - from less than $1%$ to more than $60%$. This points to the relevancy of country-level characteristics, which are the main focus of this paper.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nep_mice_prep |> \n  filter(!countryname_en %in% c(\"New Zealand\", \"Australia\")) |> \n  group_by(countryname_en) |> \n  summarize(vote_na = sum(vote == \"Declined to answer\"),\n            vote = n()) |> \n  mutate(share = vote_na/vote) |> \n  ggplot(aes(x = share, y = reorder(countryname_en, share),\n             label = paste0(vote_na, \" / \", vote), fill = vote)) +\n    geom_bar(stat = \"identity\") +\n    geom_text(size = 3, hjust = -0.5, position = position_dodge(width = 1), \n              inherit.aes = TRUE) +\n    scale_x_continuous(limits = c(0, 0.7),\n                       breaks = seq(0, 0.7, 0.1),\n                       labels = scales::label_number(scale = 100,\n                                                     suffix = \"%\")) +\n    scale_fill_gradient2(low = \"#bf212f\", mid = \"#F9E897\", high = \"#b3c58b\",\n                         midpoint = 2000) +\n    labs(x = \"\\nShare of Declined to answer\",\n         y = NULL, fill = \"N of respondents\",\n         title = \"Share and counts of those declined to disclose their vote\",\n         subtitle = \"By country and absolute number of respondents\") +\n    theme_minimal() \n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/country-level differences-1.pdf)\n:::\n:::\n\n\n\nWe then set up the imputation itself. There are two id categorical variables for cities (which in the exit poll sample equal voting stations) and countries - I retain those as predictors as they serve as fixed effects capturing the inherent country- and city- level group (cluster) differences. There are no methods in the mice family of packages to impute polynomial data with mixed effects modelling techniques, so we will have to do without the helpful properties of partial pooling.\n\nApart from the variables we are imputing there are also two auxiliary variables - those are untransformed `result_trust` and `time_to_vs` variables. We have modified them when creating variables (in the `variables_descriptive` script), however for imputation we prefer to use untransformed (apart from NA definitions) versions that contain more information. We thus set these variables and not the modified ones as predictors in the imputation - this avoids collinearity in the models. On the other hand we disallow them to predict their modified variants - this avoids circularity in the predictions.\n \n\n::: {.cell}\n\n```{.r .cell-code}\n# Dry run\nimp1dry <- mice(ep_mice_prep, seed = 1, maxit = 0)\n\n# Extract predictor matrix\npred <- imp1dry$predictorMatrix\n\n# Modify predictor matrix\n  \n  ## Exclude duplicate variables\n  pred[, \"countrycode_c\"] <- 0\n  pred[, \"countrycode_n\"] <- 0\n  pred[, \"voting_station\"] <- 0\n  \n  ## Use full-information variables for imputation\n  pred[, \"time_to_vs.less_than_hour\"] <- 0\n  pred[, \"time_to_vs.more_than_4hours\"] <- 0\n  pred[, \"result_trust_bin\"] <- 0\n\n  ## Do not impute time_to_vs and result_trust with their (collinear)\n  ## full-information alternatives\n  pred[\"time_to_vs.less_than_hour\", \"time_to_vs\"] <- 0\n  pred[\"time_to_vs.more_than_4hours\", \"time_to_vs\"] <- 0\n  pred[\"result_trust_bin\", \"result_trust\"] <- 0\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nimp1 <- futuremice(ep_mice_prep, method = c(\n  # Identificators\n  \"\", \"\", \"\", \"\", \"\",\n  # Variables to be imputed\n  \"\", \"polyreg\", \"polyreg\", \"polyreg\", \"logreg\", \"logreg\", \"polyreg\", \n  # Aux\n  \"\", \"\"), \n  predictorMatrix = pred, m = 10, maxit = 10, \n  parallelseed = 1, ncore = parallel::detectCores() - 1)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nload(here(\"data\", \"data_raw\", \"imp1.RData\"))\n```\n:::\n\n\nWe first look at convergence. The trace plot shows that imputations mix for all variables nicely, which leads us to conclude that convergence is good!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_trace(imp1) +\n  scale_color_manual(values = c(\"#b15268\", \"#69b040\", \"#9c49d6\", \"#c79830\", \n                                \"#6558b1\", \"#cc4d33\", \"#549e78\", \"#ba4c9d\", \n                                \"#8a7443\", \"#7484ac\")) +\n  labs(title = \"Imputation convergence\") +\n  theme_minimal() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/exam - convergence-1.pdf)\n:::\n:::\n\n\nWe then turn our attention to a probably most important issue with these imputations - those being the number of actual imputed values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimp1_cmp <- complete(imp1, \"long\", include = T) |> \n  mutate(imputed = factor(if_else(`.imp` > 0, 1, 0), \n                          labels = c(\"Observed\", \"Average Imputed\")),\n         imp = factor(if_else(`.imp` == 0, \"Observed\", as.character(`.imp`)))) |> \n  filter(!countryname_en %in% c(\"Australia\", \"New Zealand\"))\n\nimp1_cmp |> \n  group_by(imp) |> \n  summarize(across(c(sex, age_bin, out_of_Russia_time, \n                     time_to_vs.less_than_hour, time_to_vs.more_than_4hours, \n                     result_trust_bin), ~ sum(is.na(.)))) |> \n  select(-imp) |> \n  distinct() |> \n  rownames_to_column() |> \n  pivot_longer(cols = c(-rowname)) |> \n  mutate(name = factor(name, \n                        levels = c(\"sex\", \"age_bin\", \"out_of_Russia_time\", \n                                   \"time_to_vs.less_than_hour\",\n                                   \"time_to_vs.more_than_4hours\", \n                                   \"result_trust_bin\"),\n                        labels = c(\"Sex\", \"Age\", \"Time out of Russia\",\n                                   \"Time to voting station < 1 hour\",\n                                   \"Time to voting station > 4 hours\",\n                                   \"Trust in the result\")),\n         rowname = factor(rowname, levels = c(1, 2), labels = c(\"Imputed\",\n                                                                \"Observed\"))) |> \n  ggplot(aes(x = value, y = rowname, fill = rowname)) +\n    geom_bar(stat = \"identity\", width = 0.5) +\n    facet_wrap(~ name, scales = \"free_x\", ncol = 2) +\n    scale_fill_manual(values = c(\"#b3c58b\", \"#cc4d33\")) +\n    labs(y = NULL, x = \"\\nNumber of missing values\",\n         title = \"Imputation: number of missing values before and after\") +\n    theme_minimal() +\n    theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/examination - result-1.pdf)\n:::\n:::\n\nThe number of values that the model imputes is very low - this is because if one of the predictors contains missing values, the outcome of the imputation is also missing. There is essentially no way to correct for this issue with the data at hand - we are wary of deleting informative predictors from the imputation as the variables are already quite limited and it may lead to imprecise imputations. \n\nConsider the following influx-outflux plot: the less informative variables are those with more missing values - but they also vary systematically by age and sex, so there is no way to model the latter correctly. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nep_mice_prep |> \n  select(-countrycode_c, -countrycode_n, -voting_station, -time_to_vs.more_than_4hours,\n         -time_to_vs.less_than_hour, -result_trust_bin) |> \n  plot_flux() +\n    labs(title = \"Influx-outflux plot\") +\n    theme_minimal()\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/flux-1.pdf)\n:::\n:::\n\n\nLastly, it makes sense to examine the quality of the imputation. We plot the average share of each category across the 10 imputations performed against the distribution of observed values for each variable. The data is presented by country as we want to ensure that aggregations will be correct not only on the whole but also by country. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Sex\nimp1_cmp |> \n  mutate(na = if_else(is.na(sex)[imp == \"Observed\"] & !is.na(imp == \"1\"), 1, 0)) |> \n  filter(na == TRUE | imp == \"Observed\") |> \n  group_by(countryname_en, imputed, sex) |> \n  summarize(n = n(),\n            country_na = any(na == 1)) |> \n  drop_na() |> \n  group_by(countryname_en) |> \n  filter(!all(country_na == FALSE)) |> \n  group_by(countryname_en, imputed) |> \n  mutate(share = n/sum(n)) |> \n  ggplot(aes(x = sex, y = share, fill = imputed)) +\n    geom_bar(stat = \"identity\", position = position_dodge(preserve = \"single\"),\n             width = 0.5) +\n    facet_wrap(~ countryname_en) +\n    scale_fill_manual(values = c(\"#cc4d33\", \"#b3c58b\")) +\n    labs(x = NULL, y = \"Share of observations\\n\", \n         title = \n           \"Distributions of observed and imputed values, sex\",\n         subtitle = \n           \"Note that in most cases number of imputed values is quite small\",\n         fill = NULL) +\n    theme_minimal() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/results-1.pdf)\n:::\n\n```{.r .cell-code}\n# Age \nimp1_cmp |> \n  mutate(na = if_else(is.na(age_bin)[imp == \"Observed\"] & !is.na(imp == \"1\"), 1, 0)) |> \n  filter(na == TRUE | imp == \"Observed\") |> \n  group_by(countryname_en, imputed, age_bin) |> \n  summarize(n = n(),\n            country_na = any(na == 1)) |> \n  drop_na() |> \n  group_by(countryname_en) |> \n  filter(!all(country_na == FALSE)) |> \n  group_by(countryname_en, imputed) |> \n  mutate(share = n/sum(n)) |> \n  ggplot(aes(x = age_bin, y = share, fill = imputed)) +\n    geom_bar(stat = \"identity\", position = position_dodge(preserve = \"single\"),\n             width = 0.5) +\n    facet_wrap(~ countryname_en) +\n    scale_fill_manual(values = c(\"#cc4d33\", \"#b3c58b\")) +\n    labs(x = NULL, y = \"Share of observations\\n\", \n         title = \n           \"Distributions of observed and imputed values, age\",\n         subtitle = \n           \"Note that in most cases number of imputed values is quite small\",\n         fill = NULL) +\n    theme_minimal() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/results-2.pdf)\n:::\n\n```{.r .cell-code}\n# More than 4\nimp1_cmp |> \n  mutate(na = if_else(is.na(time_to_vs.more_than_4hours)[imp == \"Observed\"]\n                      & !is.na(imp == \"1\"), 1, 0)) |> \n  filter(na == TRUE | imp == \"Observed\") |> \n  group_by(countryname_en, imputed, time_to_vs.more_than_4hours) |> \n  summarize(n = n(),\n            country_na = any(na == 1)) |> \n  drop_na() |> \n  group_by(countryname_en) |> \n  filter(!all(country_na == FALSE)) |> \n  group_by(countryname_en, imputed) |> \n  mutate(share = n/sum(n)) |> \n  ggplot(aes(x = time_to_vs.more_than_4hours, y = share, fill = imputed)) +\n    geom_bar(stat = \"identity\", position = position_dodge(preserve = \"single\"),\n             width = 0.5) +\n    facet_wrap(~ countryname_en) +\n    scale_fill_manual(values = c(\"#cc4d33\", \"#b3c58b\")) +\n    labs(x = NULL, y = \"Share of observations\\n\", \n         title = \n           \"Distributions of observed and imputed values, `More than 4 hours to voting station`\",\n         subtitle = \n           \"Note that in most cases number of imputed values is quite small\",\n         fill = NULL) +\n    theme_minimal() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/results-3.pdf)\n:::\n\n```{.r .cell-code}\n# Out of Russia\nimp1_cmp |> \n  mutate(na = if_else(is.na(out_of_Russia_time)[imp == \"Observed\"]\n                      & !is.na(imp == \"1\"), 1, 0)) |> \n  filter(na == TRUE | imp == \"Observed\") |> \n  group_by(countryname_en, imputed, out_of_Russia_time) |> \n  summarize(n = n(),\n            country_na = any(na == 1)) |> \n  drop_na() |> \n  group_by(countryname_en) |> \n  filter(!all(country_na == FALSE)) |> \n  group_by(countryname_en, imputed) |> \n  mutate(share = n/sum(n)) |> \n  ggplot(aes(x = out_of_Russia_time, y = share, fill = imputed)) +\n    geom_bar(stat = \"identity\", position = position_dodge(preserve = \"single\"),\n             width = 0.5) +\n    facet_wrap(~ countryname_en) +\n    scale_fill_manual(values = c(\"#cc4d33\", \"#b3c58b\")) +\n    labs(x = NULL, y = \"Share of observations\\n\", \n         title = \n           \"Distributions of observed and imputed values, `Time out of Russia`\",\n         subtitle = \n           \"Note that in most cases number of imputed values is quite small\",\n         fill = NULL) +\n    theme_minimal() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/results-4.pdf)\n:::\n\n```{.r .cell-code}\n# Trust in result\nimp1_cmp |> \n  mutate(na = if_else(is.na(result_trust_bin)[imp == \"Observed\"]\n                      & !is.na(imp == \"1\"), 1, 0)) |> \n  filter(na == TRUE | imp == \"Observed\") |> \n  group_by(countryname_en, imputed, result_trust_bin) |> \n  summarize(n = n(),\n            country_na = any(na == 1)) |> \n  drop_na() |> \n  group_by(countryname_en) |> \n  filter(!all(country_na == FALSE)) |> \n  group_by(countryname_en, imputed) |> \n  mutate(share = n/sum(n)) |> \n  ggplot(aes(x = result_trust_bin, y = share, fill = imputed)) +\n    geom_bar(stat = \"identity\", position = position_dodge(preserve = \"single\"),\n             width = 0.5) +\n    facet_wrap(~ countryname_en) +\n    scale_fill_manual(values = c(\"#cc4d33\", \"#b3c58b\")) +\n    labs(x = NULL, y = \"Share of observations\\n\", \n         title = \n           \"Distributions of observed and imputed values, `Trust in the results`\",\n         subtitle = \n           \"Note that in most cases number of imputed values is quite small\",\n         fill = NULL) +\n    theme_minimal() +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](imputation_files/figure-pdf/results-5.pdf)\n:::\n:::\n\n\nAs noted in the graphs at times the number of imputed values is so low that the comparison is rather unfair. Overall we are satisfied with the imputation quality.\n\n\\section{Conclusion}\n\nBased on these results, it appears that we cannot effectively solve the missingness pattern of the data. It clearly indicates that it depends on candidate choice. However since data is decidedly Missing At Random (MAR) this needn't be an issue - except for the Declined to answer category we can still recover unbiased estimates. While we perform multiple imputations of the missing values the systemic character of the pattern precludes the process from making any sort of difference. We therefore proceed with listwise deletion of missing observations for simplicity.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}